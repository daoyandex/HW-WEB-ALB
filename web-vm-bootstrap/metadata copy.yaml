#cloud-config
timezone: Europe/Moscow
repo_update: true
repo_upgrade: true

users:
  - name: "${var.vm_user}"
    shell: /bin/bash
    sudo: ALL=(ALL:ALL) NOPASSWD:ALL
    ssh-authorized-keys:
      - ${file("${var.ssh_key_path}")}
      - ${file("${var.ssh_key_path}")}

write_files:
  - path: "/usr/local/etc/startup_nginx.sh"
    permissions: "755"
    content: |
      #!/bin/bash

      sudo apt-get update
      sudo apt-get install -y nginx
      sudo service nginx start
    defer: true

runcmd:
  - ["/usr/local/etc/startup_nginx.sh"]
  - [ systemctl, nginx-reload ]
  - [ systemctl, enable, nginx.service ]
  - [ systemctl, start, --no-block, nginx.service ]
  - [ sh, -c, "echo $(hostname | cut -d '.' -f 1 ) > /var/www/html/index.html" ]
